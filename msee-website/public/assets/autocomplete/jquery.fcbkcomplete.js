/**
 FCBKcomplete v2.8.9.3 is released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 - Jquery version required: 1.6.x
*/
/* Based on TextboxList by Guillermo Rauch http://devthought.com/ */
/**
 * width            - element width (by default 512px)
 * json_url         - url to fetch json object
 * cache            - use cache
 * height           - maximum number of element shown before scroll will apear
 * newel            - show typed text like a element
 * firstselected    - automaticly select first element from dropdown
 * filter_case      - case sensitive filter
 * filter_selected  - filter selected items from list
 * filter_begin     - filter only from begin
 * complete_text    - text for complete page
 * maxshownitems    - maximum numbers that will be shown at dropdown list (less better performance)
 * oncreate         - fire event on item create
 * onselect         - fire event on item select
 * onremove         - fire event on item remove
 * maxitimes        - maximum items that can be added
 * delay            - delay between ajax request (bigger delay, lower server time request)
 * addontab         - add first visible element on tab or enter hit
 * addoncomma       - add first visible element when pressing the comma key
 * attachto         - after this element fcbkcomplete insert own elements
 * bricket          - use square bricket with select (needed for asp or php) enabled by default
 * input_tabindex   - the tabindex of the input element
 * input_min_size   - minimum size of the input element (default: 1)
 * input_name       - value of the input element's 'name'-attribute (no 'name'-attribute set if empty)
 * select_all_text  - text for select all link
 */
(function(e,t){e.fn.fcbkcomplete=function(t){return this.queue(function(){function n(){r(),a(0)}function r(){N=e('<ul class="holder"></ul>').width(T.width),T.attachto?typeof T.attachto=="object"?T.attachto.append(N):e(T.attachto).append(N):D.after(N),k=e('<div class="facebook-auto">').width(T.width);if(T.complete_text!=""){var t=T.complete_text;k.append('<div class="default">'+t+"</div>"),T.select_all_text&&k.children(".default").append(e('<a href="" class="select_all_items">'+T.select_all_text+"</a>").click(function(){return e(D).trigger("selectAll"),!1}))}k.hover(function(){_=0},function(){_=1}),C=e('<ul id="'+P+'_feed"></ul>').width(T.width),N.after(k.prepend(C)),s()}function s(){name=D.attr("name"),T.bricket&&typeof name!="undefined"&&name.indexOf("[]")==-1&&(name+="[]");var t=e("<"+D.get(0).tagName+' name="'+name+'" id="'+P+'" multiple="multiple" class="'+D.get(0).className+' hidden">').data("cache",{});e.each(D.children("option"),function(n,r){r=e(r),t.data("cache")[r.val()]=r.text();if(r.hasClass("selected")){var i=o(r.text(),r.val(),!0,r.hasClass("locked"));t.append('<option value="'+r.val()+'" selected="selected" id="opt_'+i+'"class="selected">'+r.text()+"</option>")}}),D.after(t),D.remove(),D=t,e(D).bind("addItem",function(e,t){o(t.title,t.value,0,0,0)}),e(D).bind("removeItem",function(e,t){var n=N.children("li[rel="+t.value+"]");n.length&&u(n)}),e(D).bind("destroy",function(e,t){N.remove(),k.remove(),D.show()}),e(D).bind("selectAll",function(t,n){var r=e(D).val()||[];e.each(e(D).data("cache"),function(t,n){e.inArray(t,r)===-1&&o(n,t,0,0,0)}),C.parent().hide()})}function o(t,n,r,i,s){if(!m())return!1;var o="bit-box"+(i?" locked":""),f=F(),l=document.createTextNode(E(t)),c=e('<a class="closebutton" href="#"></a>'),h=e('<li class="'+o+'" rel="'+n+'" id="pt_'+f+'"></li>').prepend(l).append(c);N.append(h),c.click(function(){return u(e(this).parent("li")),!1});if(!r){e("#"+P+"_annoninput").remove(),a(s);var p=e('<option value="'+E(n,1)+'" id="opt_'+f+'" class="selected" selected="selected">'+E(t)+"</option>");D.append(p),T.onselect&&y(T.onselect,p),D.change()}return N.children("li.bit-box.deleted").removeClass("deleted"),S(1),f}function u(t){if(!t.hasClass("locked")){t.fadeOut("fast");var n=t.attr("id");if(T.onremove){var r=n?e("#o"+n+""):D.children("option[value="+t.attr("rel")+"]");y(T.onremove,r)}n?e("#o"+n+"").remove():D.children('option[value="'+t.attr("rel")+'"]').remove(),t.remove(),D.change(),M=0}}function a(t){var n=e('<li class="bit-input" id="'+P+'_annoninput">'),r=e('<input type="text" class="maininput" size="'+T.input_min_size+'" autocomplete="off">');T.input_tabindex>0&&r.attr("tabindex",T.input_tabindex),T.input_name!=""&&r.attr("name",T.input_name),N.append(n.append(r)),r.focus(function(){A=!0,m()&&k.fadeIn("fast")}),r.blur(function(){A=!1,_?k.fadeOut("fast"):r.focus()}),N.click(function(){T.input_min_size<0&&C.length&&x(w(r.val(),1)),r.focus(),C.length&&r.val().length>T.input_min_size?C.show():(S(1),k.children(".default").show())}),r.keypress(function(e){if(e.keyCode==j.enter)return!1;var t=T.input_min_size>r.val().length?T.input_min_size:r.val().length+1;r.attr("size",t).width(parseInt(r.css("font-size"))*t)}),r.keyup(function(t){var n=w(r.val(),1);if(t.keyCode==j.backspace&&n.length==0){S(1);if(!N.children("li.bit-box:last").hasClass("locked")){if(N.children("li.bit-box.deleted").length==0)return N.children("li.bit-box:last").addClass("deleted"),!1;if(M)return;M=1,N.children("li.bit-box.deleted").fadeOut("fast",function(){return u(e(this)),!1})}}t.keyCode!=j.downarrow&&t.keyCode!=j.uparrow&&t.keyCode!=j.leftarrow&&t.keyCode!=j.rightarrow&&n.length>T.input_min_size&&(x(n),k.children(".default").hide(),C.show())}),T.oncreate&&y(T.oncreate,r),t&&setTimeout(function(){r.focus(),k.children(".default").show()},1)}function f(t,n){C.html(""),!T.cache&&n!=null&&I.clear(),g(t),n!=null&&n.length&&e.each(n,function(e,t){I.set(w(t.key),w(t.value))});var r=T.maxshownitems<I.length()?T.maxshownitems:I.length(),i="";e.each(I.search(t),function(e,n){r&&(!T.filter_selected||!D.children('option[value="'+n.key+'"]').hasClass("selected"))&&(i+='<li rel="'+n.key+'">'+E(l(n.value,t))+"</li>",L++,r--)}),C.append(i),T.firstselected&&(O=C.children("li:visible:first"),O.addClass("auto-focus")),L>T.height?C.css({height:T.height*24+"px",overflow:"auto"}):C.css("height","auto"),m()&&k.is(":hidden")&&k.show()}function l(e,t){var n=T.filter_begin?"":"(.*)",r=T.filter_begin?"<em>$1</em>$2":"$1<em>$2</em>$3",i=n+(T.filter_case?"("+t+")(.*)":"("+t.toLowerCase()+")(.*)");try{var s=new RegExp(i,T.filter_case?"g":"gi"),e=e.replace(s,r)}catch(o){}return e}function c(){C.children("li").mouseover(function(){C.children("li").removeClass("auto-focus"),O=e(this),O.addClass("auto-focus")}),C.children("li").mouseout(function(){e(this).removeClass("auto-focus"),O=null})}function h(){C.unbind("mouseover").unbind("mouseout").mousemove(function(){c(),C.unbind("mousemove")})}function p(){var t=e("#"+P+"_annoninput").children(".maininput");c(),C.children("li").unbind("mousedown").mousedown(function(){var t=e(this);o(t.text(),t.attr("rel"),0,0,1),S(1),k.hide()}),t.unbind("keydown"),t.keydown(function(t){t.keyCode!=j.backspace&&N.children("li.bit-box.deleted").removeClass("deleted");if(!(t.keyCode!=j.enter&&t.keyCode!=j.tab&&t.keyCode!=j.comma||!b())){var n=O;return o(n.text(),n.attr("rel"),0,0,1),v(t)}if((t.keyCode==j.enter||t.keyCode==j.tab||t.keyCode==j.comma)&&!b()){if(T.newel){var r=w(e(this).val());return o(r,r,0,0,1),v(t)}if((T.addontab||T.addoncomma)&&T.newel){O=C.children("li:visible:first");var n=O;return o(n.text(),n.attr("rel"),0,0,1),v(t)}}t.keyCode==j.downarrow&&d("first"),t.keyCode==j.uparrow&&d("last")})}function d(e){h();if(O==null||O.length==0)O=C.children("li:visible:"+e),C.get(0).scrollTop=e=="first"?0:parseInt(O.get(0).scrollHeight,10)*(parseInt(C.children("li:visible").length,10)-Math.round(T.height/2));else{O.removeClass("auto-focus"),O=e=="first"?O.nextAll("li:visible:first"):O.prevAll("li:visible:first");var t=parseInt(O.prevAll("li:visible").length,10),n=parseInt(O.nextAll("li:visible").length,10);((e=="first"?t:n)>Math.round(T.height/2)||(e=="first"?t:n)<=Math.round(T.height/2))&&typeof O.get(0)!="undefined"&&(C.get(0).scrollTop=parseInt(O.get(0).scrollHeight,10)*(t-Math.round(T.height/2)))}C.children("li").removeClass("auto-focus"),O.addClass("auto-focus")}function v(e){return k.hide(),e.preventDefault(),O=null,!1}function m(){return T.maxitems!=0&&N.children("li.bit-box").length<T.maxitems}function g(t){if(T.newel&&m()){C.children("li[fckb=1]").remove();if(t.length==0)return;var n=e('<li rel="'+t+'" fckb="1">').html(E(t));C.prepend(n),L++}return}function y(e,t){var n={};for(i=0;i<t.get(0).attributes.length;i++)t.get(0).attributes[i].nodeValue!=null&&(n["_"+t.get(0).attributes[i].nodeName]=t.get(0).attributes[i].nodeValue);return e.call(e,n)}function b(){return O==null||O.length==0?!1:!0}function w(e,t){if(typeof t!="undefined"){for(i=0;i<e.length;i++){var n=e.charCodeAt(i);if(j.exclamation<=n&&n<=j.slash||j.colon<=n&&n<=j.at||j.squarebricket_left<=n&&n<=j.apostrof)e=e.replace(e[i],escape(e[i]))}e=e.replace(/(\{|\}|\*)/i,"\\$1")}return e.replace(/script(.*)/g,"")}function E(e,t){return e=e.toString(),e=e.replace("\\",""),typeof t!="undefined"?e:unescape(e)}function S(e){C.children().remove(),e&&C.hide()}function x(t){L=0;if(T.json_url&&m())if(T.cache&&B.get(t))f(t),p();else{H++;var n=H;setTimeout(function(){if(n!=H)return;e.getJSON(T.json_url,{tag:E(t)},function(e){if(!A)return;f(t,e),B.set(t,1),p()})},T.delay)}else f(t),p()}var T=e.extend({json_url:null,width:512,cache:!1,height:"10",newel:!1,addontab:!1,addoncomma:!1,firstselected:!1,filter_case:!1,filter_selected:!1,filter_begin:!1,complete_text:"Start to type...",select_all_text:null,maxshownitems:30,maxitems:10,oncreate:null,onselect:null,onremove:null,attachto:null,delay:350,input_tabindex:0,input_min_size:1,input_name:"",bricket:!0},t),N=null,C=null,k=null,L=0,A=!1,O=null,M=0,_=1,D=e(this),P=D.attr("id"),H=0,B={set:function(e,t){var n=D.data("jsoncache");n[e]=t,D.data("jsoncache",n)},get:function(e){return D.data("jsoncache")[e]!="undefined"?D.data("jsoncache")[e]:null},init:function(){D.data("jsoncache",{})}},j={enter:13,tab:9,comma:188,backspace:8,leftarrow:37,uparrow:38,rightarrow:39,downarrow:40,exclamation:33,slash:47,colon:58,at:64,squarebricket_left:91,apostrof:96},F=function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",t="";for(var n=0;n<32;n++){var r=Math.floor(Math.random()*e.length);t+=e.substring(r,r+1)}return t},I={search:function(t,n){var r=new Array,i=new RegExp((T.filter_begin?"^":"")+t,T.filter_case?"g":"gi");return e.each(D.data("cache"),function(e,t){typeof t.search=="function"&&t.search(i)!=-1&&r.push({key:e,value:t})}),r},set:function(e,t){var n=D.data("cache");n[e]=t,D.data("cache",n)},get:function(e){return D.data("cache")[e]!="undefined"?D.data("cache")[e]:null},clear:function(){D.data("cache",{})},length:function(){if(typeof D.data("cache")=="object"){var e=0;for(i in D.data("cache"))e++;return e}return D.data("cache").length},init:function(){D.data("cache")=="undefined"&&D.data("cache",{})}};return n(),B.init(),I.init(),this})}})(jQuery);